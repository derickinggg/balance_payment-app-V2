<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayPal Advanced Checkout + Balance</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;margin:0;background:#0b1020;color:#e8edff}
    .wrap{max-width:960px;margin:30px auto;padding:20px}
    .tabs{display:flex;gap:6px;margin-bottom:12px}
    .tab{padding:10px 14px;border-radius:10px;background:#0e1430;border:1px solid #233056;cursor:pointer}
    .tab.active{background:#16234a;border-color:#345}
    .panel{background:#111735;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3357;background:#0e1430;color:#dfe6ff}
    label{font-size:12px;opacity:.9;letter-spacing:.2px}
    .row{display:flex;gap:12px}
    .row>div{flex:1}
    button{background:#2563eb;border:0;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:600;letter-spacing:.2px}
    .muted{opacity:.7;font-size:12px}
    #result{white-space:pre-wrap;font-family:'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;background:#0a0f24;padding:12px;border-radius:10px;margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    /* Improve typographic rhythm */
    h2{font-weight:700;letter-spacing:-0.01em}
    .amount,.tab,button,input,select{font-feature-settings:'cv05' 1,'tnum' 1,'ss01' 1}
    /* Transaction list monospace for amounts */
    .tx-amount{font-family:'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;font-weight:600}
    .tx-credit{color:#ffffff}
    .tx-debit{color:#ffffff}
    /* Current balance amount emphasis */
    #current-balance .tx-amount{font-family:'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;font-weight:700;font-size:16px;opacity:1}
    /* Section title */
    .section-title{display:flex;align-items:center;gap:8px;font-weight:600;margin:8px 0 6px 0;color:#c8d3ff}
    .section-title svg{width:16px;height:16px;opacity:.8}
    /* Transaction cards */
    .tx-list{display:flex;flex-direction:column;gap:12px}
    .tx-card{background:#0e1430;border:1px solid #1f2747;border-radius:14px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
    .tx-left{display:flex;flex-direction:column;gap:6px}
    .tx-title{font-weight:600;color:#e8edff}
    .tx-meta{color:#a5b0d6;font-size:12px}
    .tx-id{opacity:.9}
    .tx-right{font-size:16px}
    /* Checkout result card */
    .result-card{background:#0e1430;border:1px solid #1f2747;border-radius:14px;padding:16px;margin-top:12px}
    .result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .result-title{font-weight:600;color:#e8edff}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .badge.ok{background:#12381f;color:#22c55e;border:1px solid #1e7a3a}
    .badge.err{background:#3a1212;color:#ef4444;border:1px solid #8a1a1a}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px}
    .kv label{opacity:.75;font-size:12px}
    .kv div{color:#e8edff}
    .raw{margin-top:12px}
    .raw summary{cursor:pointer;color:#a5b0d6}
    .raw pre{white-space:pre-wrap;background:#0a0f24;border:1px solid #1f2747;border-radius:10px;padding:12px;margin:8px 0 0 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>PayPal Tools</h2>
    <p class="muted">Paste your PayPal app credentials below. Credentials are only used for your requests.</p>

    <div class="panel" style="margin-bottom:12px">
      <div class="row">
        <div>
          <label>Environment</label>
          <select id="env">
            <option value="sandbox">Sandbox</option>
            <option value="live">Live</option>
          </select>
        </div>
        <div>
          <label>PayPal Client ID</label>
          <input id="clientId" placeholder="A..." />
        </div>
        <div>
          <label>PayPal Client Secret</label>
          <input id="clientSecret" placeholder="E..." />
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="checkout">Checkout</div>
      <div class="tab" data-tab="balance">Balance</div>
    </div>

    <div id="checkout" class="panel">
      <div class="row">
        <div>
          <label>Amount</label>
          <input id="amount" value="1.00" />
        </div>
        <div style="align-self:flex-end">
          <button id="validate">Validate API</button>
        </div>
      </div>

      <div style="margin-top:16px">
        <div id="card-name-field"></div>
        <div id="card-number-field" style="margin-top:12px"></div>
        <div class="row" style="margin-top:12px">
          <div id="card-expiry-field"></div>
          <div id="card-cvv-field"></div>
        </div>
        <button id="pay" style="margin-top:12px">Pay</button>
      </div>
      <div id="checkout-result" style="margin-top:12px"></div>
    </div>

    <div id="balance" class="panel" style="display:none">
      <div class="row">
        <div>
          <label>Lookback days</label>
          <input id="days" value="7" />
        </div>
        <div style="align-self:flex-end" class="row">
          <button id="get-current">Get Current Balance</button>
          <button id="list-tx">List Recent Transactions</button>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <div id="current-balance" class="muted"></div>
        </div>
        <div style="grid-column:1/-1">
          <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5 0 .34-.03.67-.1 1h2.02c.05-.33.08-.66.08-1 0-3.87-3.13-7-7-7Zm-5 5c0-.34.03-.67.1-1H5.08c-.05.33-.08.66-.08 1 0 3.87 3.13 7 7 7v3l4-4-4-4v3c-2.76 0-5-2.24-5-5Z" fill="#9fb0ff"/></svg>
            Recent Transactions
          </div>
          <div id="tx-list" class="tx-list"></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    let cardFieldsInstance = null;
    let clientToken = null;

    // Persist credentials locally for convenience (not secure; for demo only)
    function persistCreds(){
      try{
        localStorage.setItem('pp_env', document.getElementById('env').value);
        localStorage.setItem('pp_clientId', document.getElementById('clientId').value.trim());
        localStorage.setItem('pp_clientSecret', document.getElementById('clientSecret').value.trim());
      }catch(_){/* ignore */}
    }
    function restoreCreds(){
      try{
        const env = localStorage.getItem('pp_env');
        const id = localStorage.getItem('pp_clientId');
        const sec = localStorage.getItem('pp_clientSecret');
        if(env) document.getElementById('env').value = env;
        if(id) document.getElementById('clientId').value = id;
        if(sec) document.getElementById('clientSecret').value = sec;
      }catch(_){/* ignore */}
    }

    // Restore credentials on load
    restoreCreds();

    function tabTo(name){
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      document.getElementById('checkout').style.display = name==='checkout' ? '' : 'none';
      document.getElementById('balance').style.display = name==='balance' ? '' : 'none';
    }
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>tabTo(t.dataset.tab)));

    async function post(url, body){
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
      const data = await res.json();
      if(!res.ok) throw new Error(data?.error || JSON.stringify(data));
      return data;
    }

    function showCheckout(obj){
      const mount = document.getElementById('checkout-result');
      if (!obj || typeof obj !== 'object') {
        mount.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj,null,2);
        return;
      }
      try{
        // Try to find useful fields from capture response
        const status = obj.status || obj.result?.status || '—';
        const capture = obj?.purchase_units?.[0]?.payments?.captures?.[0] || obj?.result?.purchase_units?.[0]?.payments?.captures?.[0] || null;
        const amount = capture?.amount?.value || obj?.purchase_units?.[0]?.amount?.value || '—';
        const currency = capture?.amount?.currency_code || obj?.purchase_units?.[0]?.amount?.currency_code || 'USD';
        const orderId = obj?.id || obj?.result?.id || capture?.id || '—';
        const card = obj?.payment_source?.card || obj?.result?.payment_source?.card || {};
        const brand = card?.brand || '—';
        const last4 = card?.last_digits || '—';
        const expiry = card?.expiry || '—';
        const bank = card?.bin_details?.issuing_bank || '—';
        const country = card?.bin_details?.bin_country_code || '—';

        const ok = (status === 'COMPLETED' || status === 'APPROVED' || status === 'CAPTURED');
        const badge = ok ? '<span class="badge ok">COMPLETED</span>' : `<span class="badge err">${status}</span>`;

        mount.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="result-title">Payment Summary</div>
              ${badge}
            </div>
            <div class="kv">
              <label>Order ID</label><div>${orderId}</div>
              <label>Amount</label><div><span class="tx-amount">$${Number(amount).toFixed(2)} ${currency}</span></div>
              <label>Card</label><div>${brand} •••• ${last4}</div>
              <label>Expiry</label><div>${expiry}</div>
              <label>Issuing Bank</label><div>${bank}</div>
              <label>Country</label><div>${country}</div>
            </div>
            <details class="raw">
              <summary>View raw response</summary>
              <pre>${escapeHtml(JSON.stringify(obj, null, 2))}</pre>
            </details>
          </div>
        `;
      }catch(e){
        mount.textContent = JSON.stringify(obj, null, 2);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    async function loadSDK(clientId, currency='USD', clientToken){
      const existing = document.getElementById('pp-sdk');
      if(existing) existing.remove();
      await new Promise((resolve)=>{
        const s = document.createElement('script');
        s.id = 'pp-sdk';
        s.src = `https://www.paypal.com/sdk/js?components=card-fields&client-id=${encodeURIComponent(clientId)}&currency=${currency}&intent=capture&commit=true`;
        if (clientToken) s.setAttribute('data-client-token', clientToken);
        s.onload = ()=> resolve();
        s.onerror = ()=> resolve();
        document.head.appendChild(s);
      });
    }

    async function renderCardFields(){
      if(!window.paypal || !paypal.CardFields){ showCheckout('SDK not loaded'); return; }
      cardFieldsInstance = paypal.CardFields({
        createOrder: async () => {
          const amount = document.getElementById('amount').value || '1.00';
          const clientId = document.getElementById('clientId').value.trim();
          const clientSecret = document.getElementById('clientSecret').value.trim();
          const env = document.getElementById('env').value;
          const order = await post('/api/orders', { amount, clientId, clientSecret, env });
          return order.id;
        },
        onApprove: async (data) => {
          const clientId = document.getElementById('clientId').value.trim();
          const clientSecret = document.getElementById('clientSecret').value.trim();
          const env = document.getElementById('env').value;
          const capture = await post(`/api/orders/${data.orderID}/capture`, { clientId, clientSecret, env });
          showCheckout(capture);
        },
        onError: (err)=> showCheckout(err?.message || String(err)),
      });
      cardFieldsInstance.NameField().render('#card-name-field');
      cardFieldsInstance.NumberField().render('#card-number-field');
      cardFieldsInstance.ExpiryField().render('#card-expiry-field');
      cardFieldsInstance.CVVField().render('#card-cvv-field');
    }

    // Save creds whenever user types or changes env
    document.getElementById('env').addEventListener('change', persistCreds);
    document.getElementById('clientId').addEventListener('input', persistCreds);
    document.getElementById('clientSecret').addEventListener('input', persistCreds);

    document.getElementById('validate').addEventListener('click', async ()=>{
      try{
        const clientId = document.getElementById('clientId').value.trim();
        const clientSecret = document.getElementById('clientSecret').value.trim();
        const env = document.getElementById('env').value;
        persistCreds();
        if(!clientId || !clientSecret){ showCheckout('Enter Client ID and Secret'); return; }
        const token = await post('/api/client-token', { clientId, clientSecret, env });
        clientToken = token.client_token;
        await loadSDK(clientId, 'USD', clientToken);
        showCheckout('Validated. SDK loaded.');
        await renderCardFields();
      }catch(e){ showCheckout(e.message); }
    });

    document.getElementById('pay').addEventListener('click', async ()=>{
      try{
        if(!cardFieldsInstance){ showCheckout('Validate first to render fields.'); return; }
        await cardFieldsInstance.submit({});
      }catch(e){ showCheckout(e?.message || String(e)); }
    });

    // Balance actions
    function fmt(n){ return typeof n === 'number' ? n.toFixed(2) : n; }
    function renderTxList(data){
      const list = data?.transaction_details || [];
      const html = list.slice(0,10).map(t=>{
        const info = t.transaction_info || {}; const payer = t.payer_info || {}; const amt = info.transaction_amount || {}; 
        const code = info.transaction_event_code || '';
        const isCredit = (code === 'T0006' || code === 'T0001');
        const cls = isCredit ? 'tx-amount tx-credit' : 'tx-amount tx-debit';
        const sign = '';
        const value = typeof amt.value !== 'undefined' ? Number(amt.value).toFixed(2) : '';
        const currency = amt.currency_code || '';
        const title = isCredit ? 'Payment Received' : 'Transaction';
        const when = info.transaction_initiation_date ? new Date(info.transaction_initiation_date).toLocaleString() : '';
        const id = info.transaction_id || info.paypal_reference_id || '';
        return `<div class="tx-card">`
          + `<div class="tx-left">`
          +   `<div class="tx-title">${title}</div>`
          +   `<div class="tx-meta">${when}</div>`
          +   `<div class="tx-meta tx-id">ID: ${id}</div>`
          + `</div>`
          + `<div class="tx-right ${cls}">$${value}</div>`
        + `</div>`;
      });
      document.getElementById('tx-list').innerHTML = html.join('');
    }

    document.getElementById('get-current').addEventListener('click', async ()=>{
      const clientId = document.getElementById('clientId').value.trim();
      const clientSecret = document.getElementById('clientSecret').value.trim();
      const env = document.getElementById('env').value;
      persistCreds();
      try{
        const data = await post('/api/balance/current', { clientId, clientSecret, env });
        if (data?.balances) {
          const primary = (data.balances||[]).find(b=>b.primary) || data.balances[0];
          const val = primary?.total_balance?.value || primary?.available_balance?.value || '0.00';
          const cur = primary?.total_balance?.currency_code || primary?.currency_code || 'USD';
          document.getElementById('current-balance').innerHTML = `Current balance: <span class="tx-amount">${val} ${cur}</span>`;
        } else if (data?.balance) {
          document.getElementById('current-balance').innerHTML = `Derived balance: <span class=\"tx-amount\">${data.balance} ${data.currency||'USD'}</span>`;
        } else {
          document.getElementById('current-balance').textContent = JSON.stringify(data);
        }
      }catch(e){ document.getElementById('current-balance').textContent = e.message; }
    });

    document.getElementById('list-tx').addEventListener('click', async ()=>{
      const clientId = document.getElementById('clientId').value.trim();
      const clientSecret = document.getElementById('clientSecret').value.trim();
      const env = document.getElementById('env').value;
      const days = document.getElementById('days').value;
      persistCreds();
      try{
        const data = await post('/api/balance/transactions', { clientId, clientSecret, env, days });
        renderTxList(data);
      }catch(e){ document.getElementById('tx-list').textContent = e.message; }
    });
  </script>
</body>
</html>


